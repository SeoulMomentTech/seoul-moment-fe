name: code-review

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  review:
    if: |
      github.event.pull_request.draft == false &&
      !contains(github.event.pull_request.title, '[skip review]') &&
      !contains(github.event.pull_request.title, '[no review]') &&
      !contains(github.event.pull_request.title, 'WIP')

    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write
      pull-requests: write
      issues: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          persist-credentials: false
      - name: Delete previous review comments
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pull_number = context.payload.pull_request.number;

            const { data: comments } = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number: pull_number,
            });

            const botComments = comments.filter(c => 
              c.user.login === 'opencode-agent[bot]' || 
              (c.body.includes('ðŸ¤– **AI Code Review**') || c.body.includes('<!-- opencode-review -->') || c.body.includes('AI Code Review'))
            );

            for (const comment of botComments) {
              await github.rest.issues.deleteComment({ owner, repo, comment_id: comment.id });
            }

      - name: Run AI Code Review Script
        run: node .github/scripts/ai-code-review.js
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
